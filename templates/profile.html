{% extends "base.html" %}

{% block title %}Profile - NEET/JEE Learning App{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h4>Profile Information</h4>
            </div>
            <div class="card-body">
                <p><strong>Name:</strong> {{ user.name }}</p>
                <p><strong>Email:</strong> {{ user.email }}</p>
                <p><strong>Class:</strong> {{ user.class_level }}</p>
                <p><strong>Stream:</strong> {{ user.stream }}</p>
                <p><strong>Current Level:</strong> 
                    <span class="badge bg-primary">{{ user.level }}</span>
                </p>
                <p><strong>Initial Test Score:</strong> {{ user.initial_test_score }}</p>
                <p><strong>Member Since:</strong> {{ user.created_at.strftime('%B %Y') if user.created_at else 'Recently' }}</p>
            </div>
        </div>
        
        {% if user.weak_topics and user.weak_topics != '{}' %}
        <div class="card mt-3">
            <div class="card-header">
                <h5>Current Weak Areas</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Weak areas will be identified after taking tests.</p>
            </div>
        </div>
        {% endif %}
        
        {% if user.strong_topics and user.strong_topics != '{}' %}
        <div class="card mt-3">
            <div class="card-header">
                <h5>Strong Areas</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Strong areas will be identified after taking tests.</p>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4>Test History</h4>
            </div>
            <div class="card-body">
                {% if test_history %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Test Type</th>
                                    <th>Score</th>
                                    <th>Percentage</th>
                                    <th>Time Taken</th>
                                    <th>Subject Scores</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for test in test_history %}
                                <tr>
                                    <td>{{ test.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <span class="badge bg-secondary">{{ test.test_type.title() }}</span>
                                    </td>
                                    <td>{{ test.score }}/{{ test.total_questions * 4 }}</td>
                                    <td>
                                        {% set max_score = test.total_questions * 4 %}
                                        {% set percentage = ((test.score / max_score * 100) if max_score > 0 else 0) %}
                                        <span class="badge {% if percentage >= 80 %}bg-success{% elif percentage >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ "%.1f"|format(percentage) }}%
                                        </span>
                                    </td>
                                    <td>{{ test.time_taken or 'N/A' }} min</td>
                                    <td>
                                        <small>Overall performance tracked</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No test history available. Take your first test to see your progress!</p>
                    <a href="{{ url_for('initial_test') if user.initial_test_score == 0 else url_for('adaptive_test') }}" 
                       class="btn btn-primary">
                        {% if user.initial_test_score == 0 %}Take Initial Test{% else %}Take Adaptive Test{% endif %}
                    </a>
                {% endif %}
            </div>
        </div>
        
        {% if test_history|length > 1 %}
        <div class="card mt-3">
            <div class="card-header">
                <h5>Performance Trends</h5>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" 
                        width="400" 
                        height="200"
                        data-labels='{{ chart_labels|tojson }}'
                        data-scores='{{ chart_scores|tojson }}'></canvas>
            </div>
        </div>
        
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            // Get chart data from data attributes
            const canvas = document.getElementById('performanceChart');
            const chartLabels = JSON.parse(canvas.dataset.labels);
            const chartScores = JSON.parse(canvas.dataset.scores);
            
            const ctx = canvas.getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Test Scores (%)',
                        data: chartScores,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        </script>
        {% endif %}
    </div>
</div>
{% endblock %}